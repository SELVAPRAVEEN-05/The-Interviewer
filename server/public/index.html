<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Video Chat</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .video-container {
            width: 50%;
        }
        video {
            width: 100%;
            height: 400px;
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="local-video" autoplay></video>
        <video id="remote-video" autoplay></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');

        // Access camera and microphone
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localVideo.srcObject = stream;
            })
            .catch(error => {
                console.error('Access denied for camera/microphone:', error);
            });

        // Handle ICE candidates
        let peerConnection = null;
        let roomId = 'main-room';

        socket.on('connect', () => {
            socket.emit('join', roomId);
        });

        socket.on('user-connected', (userId) => {
            console.log('User connected:', userId);
            createOffer();
        });

        function createOffer() {
            peerConnection = new RTCPeerConnection();

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', event.candidate, roomId);
                }
            };

            peerConnection.onaddstream = (event) => {
                remoteVideo.srcObject = event.stream;
            };

            const localStream = localVideo.srcObject;
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.createOffer().then(offer => {
                return peerConnection.setLocalDescription(new RTCSessionDescription({ type: 'offer', sdp: offer }));
            }).then(() => {
                socket.emit('offer', peerConnection.localDescription, roomId);
            });
        }

        socket.on('offer', (offer, userId) => {
            if (!peerConnection) {
                createOffer();
            }
            const offerDesc = new RTCSessionDescription({ type: 'offer', sdp: offer });
            peerConnection.setRemoteDescription(offerDesc)
                .then(() => peerConnection.createAnswer())
                .then(answer => {
                    return peerConnection.setLocalDescription(new RTCSessionDescription({ type: 'answer', sdp: answer }));
                })
                .then(() => {
                    socket.emit('answer', peerConnection.localDescription, roomId);
                });
        });
    </script>
</body>
</html>